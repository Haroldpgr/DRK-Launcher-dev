var D=Object.defineProperty;var v=(p,s,o)=>s in p?D(p,s,{enumerable:!0,configurable:!0,writable:!0,value:o}):p[s]=o;var f=(p,s,o)=>v(p,typeof s!="symbol"?s+"":s,o);import{n as l,p as b}from"./index-D7fue8Mp.js";class ${constructor(){f(this,"downloads",new Map);f(this,"observers",[]);f(this,"downloadNotifications",new Map);f(this,"STORAGE_KEY","launcher_downloads_v1");f(this,"instanceDownloadProgress",new Map);window.api.download.onProgress(this.handleProgress.bind(this)),window.api.download.onComplete(this.handleComplete.bind(this)),window.api.download.onError(this.handleError.bind(this)),this.loadFromStorage()}handleProgress(s,o){const t=this.downloads.get(o.itemId);if(t){t.progress=Math.round(o.progress*100),t.downloadedBytes=Math.round(t.totalBytes*o.progress);const e=(Date.now()-t.startTime)/1e3;e>0&&(t.speed=Math.round(t.downloadedBytes/e));const r=this.downloadNotifications.get(o.itemId);r&&l.updateProgress(r,t.progress,`${t.name} - ${t.progress}%`),this.notifyObservers();for(const[i,n]of this.instanceDownloadProgress)if(n.downloads.includes(o.itemId)){let a=0,c=0;for(const w of n.downloads){const h=this.downloads.get(w);h&&(a+=h.downloadedBytes,c+=h.totalBytes)}const d=this.downloads.get(i);if(d&&c>0){d.progress=Math.round(a/c*100),d.downloadedBytes=a;const w=(Date.now()-d.startTime)/1e3;w>0&&(d.speed=Math.round(a/w));const h=this.downloadNotifications.get(i);h&&l.updateProgress(h,d.progress,`${d.name} - ${d.progress}%`),this.notifyObservers()}break}}}handleComplete(s,o){const t=this.downloads.get(o.itemId);if(t){t.status="completed",t.progress=100,t.endTime=Date.now(),t.path=o.filePath,this.persistDownloads();const e=this.downloadNotifications.get(o.itemId);e?(l.updateProgress(e,100,`${t.name} - ¡Completado!`),setTimeout(()=>{l.dismiss(e),this.downloadNotifications.delete(o.itemId)},3e3)):l.show({title:"Descarga completada",message:t.name,type:"success",showProgress:!1}),this.notifyObservers()}}handleError(s,o){const t=this.downloads.get(o.itemId);if(t){t.status="error",t.endTime=Date.now(),this.persistDownloads();const e=this.downloadNotifications.get(o.itemId);e?l.updateProgress(e,0,`${t.name} - Error: ${o.message}`):l.show({title:"Error en descarga",message:`${t.name} - ${o.message}`,type:"error",showProgress:!1}),this.notifyObservers()}}subscribe(s){return this.observers.push(s),s(this.getAllDownloads()),()=>{this.observers=this.observers.filter(o=>o!==s)}}notifyObservers(){const s=this.getAllDownloads();this.observers.forEach(o=>o(s))}loadFromStorage(){try{const s=localStorage.getItem(this.STORAGE_KEY);if(!s)return;const o=JSON.parse(s),t=Date.now()-15*24*60*60*1e3,e=o.filter(r=>{if(r.status==="downloading"||r.status==="pending"||r.status==="paused")return!0;if(r.status==="completed"&&r.endTime)return r.endTime>t;if(r.status==="error"&&r.endTime){const i=Date.now()-6048e5;return r.endTime>i}return!0});e.length<o.length?(this.downloads=new Map(e.map(r=>[r.id,r])),this.persistDownloads()):this.downloads=new Map(e.map(r=>[r.id,r])),this.notifyObservers()}catch(s){console.error("Error cargando historial de descargas",s)}}persistDownloads(){try{const s=Array.from(this.downloads.values());localStorage.setItem(this.STORAGE_KEY,JSON.stringify(s))}catch(s){console.error("Error guardando historial de descargas",s)}}getCurrentProfileUsername(){return b.getCurrentProfile()}isOwnedByCurrentProfile(s){const o=this.getCurrentProfileUsername();return o?s.profileUsername===o||!s.profileUsername:!0}addDownloadToHistory(s){this.downloads.set(s.id,s),this.persistDownloads(),this.notifyObservers()}createDownload(s,o){const t=`download_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,e=this.getCurrentProfileUsername()||void 0,r={id:t,name:o,url:s,status:"pending",progress:0,downloadedBytes:0,totalBytes:100*1024*1024,startTime:Date.now(),speed:0,profileUsername:e};this.downloads.set(t,r),this.persistDownloads();const i=l.show({title:"Iniciando descarga",message:o,type:"info",progress:0,showProgress:!0});return this.downloadNotifications.set(t,i),this.notifyObservers(),this.startDownload(r.id),r}async startDownload(s){const o=this.downloads.get(s);if(o){o.status==="completed"&&(o.progress=0,o.downloadedBytes=0,o.startTime=Date.now(),o.speed=0),o.status="downloading",this.persistDownloads(),this.notifyObservers();try{const t={url:o.url,filename:o.name.replace(/\s+/g,"_"),itemId:s};window.api.download.start(t)}catch(t){console.error("Error downloading file:",t),o.status="error",this.persistDownloads(),this.notifyObservers()}}}downloadFile(s,o,t){const e=`download_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,r=t||o,i=this.getCurrentProfileUsername()||void 0,n={id:e,name:r,url:s,status:"pending",progress:0,downloadedBytes:0,totalBytes:100*1024*1024,startTime:Date.now(),speed:0,profileUsername:i};this.downloads.set(e,n),this.persistDownloads(),this.notifyObservers();const a={url:s,filename:o,itemId:e};return window.api.download.start(a),n}async downloadInstance(s,o){const t=`instance_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,e=this.getCurrentProfileUsername()||void 0,r=5*1024*1024,i=o.length*r,n={id:t,name:`Instalación de ${s} - ${o.length} archivos`,url:"",status:"downloading",progress:0,downloadedBytes:0,totalBytes:i,startTime:Date.now(),speed:0,profileUsername:e};this.downloads.set(t,n),this.persistDownloads();const a=l.show({title:"Instalando Instancia",message:`Instalando ${s} (${o.length} archivos)`,type:"info",progress:0,showProgress:!0});this.downloadNotifications.set(t,a),this.notifyObservers(),this.instanceDownloadProgress.set(t,{total:o.length,completed:0,downloads:[]});let c=0;for(const d of o){const w=`download_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,h=r,m={id:w,name:d.displayName,url:d.url,status:"pending",progress:0,downloadedBytes:0,totalBytes:h,startTime:Date.now(),speed:0,profileUsername:e};this.downloads.set(w,m),this.persistDownloads();const g=this.instanceDownloadProgress.get(t);g&&(g.downloads.push(w),this.instanceDownloadProgress.set(t,g)),this.notifyObservers();const y={url:d.url,filename:d.filename,itemId:w};await this.startDownloadAndWait(w,y),c++;const u=Math.round(c/o.length*100);n.progress=Math.min(100,u),l.updateProgress(a,u,`${s} - ${c}/${o.length} archivos`),this.notifyObservers()}n.status="completed",n.progress=100,n.endTime=Date.now(),this.persistDownloads(),l.updateProgress(a,100,`${s} - ¡Instalación completada!`),setTimeout(()=>{l.dismiss(a),this.downloadNotifications.delete(t)},5e3),this.notifyObservers(),setTimeout(()=>{this.instanceDownloadProgress.delete(t)},1e4)}async startDownloadAndWait(s,o){return new Promise((t,e)=>{window.api.download.onProgress((r,i)=>{if(i.itemId===s){const n=this.downloads.get(s);if(n){n.progress=Math.round(i.progress*100),n.downloadedBytes=Math.round(n.totalBytes*i.progress);const a=(Date.now()-n.startTime)/1e3;a>0&&(n.speed=Math.round(n.downloadedBytes/a))}this.notifyObservers()}}),window.api.download.onComplete((r,i)=>{if(i.itemId===s){const n=this.downloads.get(s);n&&(n.status="completed",n.progress=100,n.endTime=Date.now(),n.path=i.filePath),this.persistDownloads(),this.notifyObservers(),t()}}),window.api.download.onError((r,i)=>{if(i.itemId===s){const n=this.downloads.get(s);n&&(n.status="error",n.endTime=Date.now()),this.persistDownloads(),this.notifyObservers(),e(new Error(i.message))}}),window.api.download.start(o)})}pauseDownload(s){const o=this.downloads.get(s);o&&o.status==="downloading"&&(o.status="paused",this.notifyObservers())}resumeDownload(s){const o=this.downloads.get(s);o&&o.status==="paused"&&this.startDownload(s)}cancelDownload(s){const o=this.downloads.get(s);o&&(o.status="error",o.endTime=Date.now(),this.persistDownloads(),this.notifyObservers())}getDownload(s){return this.downloads.get(s)}getAllDownloads(){return Array.from(this.downloads.values()).filter(s=>this.isOwnedByCurrentProfile(s)).sort((s,o)=>o.startTime-s.startTime)}getActiveDownloads(){return Array.from(this.downloads.values()).filter(s=>(s.status==="downloading"||s.status==="paused")&&this.isOwnedByCurrentProfile(s)).sort((s,o)=>o.startTime-s.startTime)}getCompletedDownloads(){return Array.from(this.downloads.values()).filter(s=>s.status==="completed"&&this.isOwnedByCurrentProfile(s)).sort((s,o)=>(o.endTime||0)-(s.endTime||0))}clearCompleted(){const s=this.getCurrentProfileUsername(),o=Array.from(this.downloads.entries());for(const[t,e]of o)e.status==="completed"&&(!s||e.profileUsername===s||!e.profileUsername)&&this.downloads.delete(t);this.persistDownloads(),this.notifyObservers()}clearErrors(){const s=this.getCurrentProfileUsername(),o=Array.from(this.downloads.entries());for(const[t,e]of o)e.status==="error"&&(!s||e.profileUsername===s||!e.profileUsername)&&this.downloads.delete(t);this.persistDownloads(),this.notifyObservers()}clearCompletedAndErrors(){const s=this.getCurrentProfileUsername(),o=Array.from(this.downloads.entries());for(const[t,e]of o)(e.status==="completed"||e.status==="error")&&(!s||e.profileUsername===s||!e.profileUsername)&&this.downloads.delete(t);this.persistDownloads(),this.notifyObservers()}removeFromHistory(s){this.downloads.has(s)&&(this.downloads.delete(s),this.persistDownloads(),this.notifyObservers())}async downloadJavaFromAdoptium(s,o,t){const e=`https://api.adoptium.net/v3/binary/latest/${s}/ga/jdk/temurin/${o}/${t}/normal/hotspot/jdk`;try{const r=await fetch(e);if(!r.ok)throw new Error(`Error al obtener la URL de descarga: ${r.status}`);const i=await r.json(),n=i.uri||i.binary.link;return this.downloadFile(n,`java-${s}-${o}-${t}.zip`,`Java ${s} (${o}/${t})`)}catch(r){console.error("Error downloading Java from Adoptium:",r);const i=this.downloadFile("",`java-${s}-${o}-${t}.zip`,`Error: Java ${s} (${o}/${t})`);throw i.status="error",this.notifyObservers(),r}}}const I=new $;export{I as d};
